{% extends 'base.html' %}
{% load static %}

{% block title %}پیام‌ها{% endblock %}

{% block content %}
<div class="container-fluid p-0" style="height: 100vh;">
  <div class="row g-0 h-100">


    <div class="col-12 col-md-4 col-lg-3 border-start h-100 overflow-hidden" style="background: white;">
      {% include 'message_app/chats.html' %}
    </div>


    <div class="col-12 col-md-8 col-lg-9 h-100 d-flex flex-column bg-light bg-opacity-25">
      {% if message_detail %}
        <!-- هدر چت -->
        <div class="bg-white p-3 d-flex align-items-center border-bottom">
          <img src="{% if contact.profile_photo %}{{ contact.profile_photo.url }}{% else %}{% static 'message_app/images/Circle-icons-profile.svg.png' %}{% endif %}"
               class="avatar me-3"
               onclick="window.location.href='{% url 'profile_app:contact_profile' contact.id %}'"
               style="cursor: pointer;">
          <div class="flex-grow-1">
            <h6 class="fw-bold mb-0" onclick="window.location.href='{% url 'profile_app:contact_profile' contact.id %}'" style="cursor: pointer;">
              {{ contact_name }}
            </h6>
          </div>
          <div class="dropdown">
            <button class="btn btn-light rounded-circle py-2" data-bs-toggle="dropdown">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-3 p-2">
              <li><a class="dropdown-item rounded-3" href="{% url 'profile_app:contact_profile' contact.id %}"><i class="bi bi-person me-2"></i>مشاهده پروفایل</a></li>
              <li><a class="dropdown-item rounded-3 text-danger" href="#"><i class="bi bi-trash me-2"></i>حذف گفتگو</a></li>
            </ul>
          </div>
        </div>

        <!-- ناحیه پیام‌ها -->
        <div class="flex-grow-1 overflow-auto p-4" id="messagesContainer">
          {% for message in messages %}
            {% if message.sender == request.user.profile %}
              <div class="d-flex justify-content-end mb-3">
                <div class="bg-primary-gradient text-white rounded-3 p-3" style="max-width: 70%; border-radius: 18px 18px 5px 18px !important;">
                  <p class="mb-1 small">{{ message.text }}</p>
                  <div class="d-flex justify-content-end align-items-center gap-2">
                    <small class="opacity-75" style="font-size: 0.7rem;">{{ message.created_at|time:'H:i' }}</small>
                    <i class="bi bi-check2-all {% if message.is_read %}text-info{% else %}opacity-75{% endif %}" style="font-size: 1rem;"></i>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="d-flex mb-3">
                <img src="{% if contact.profile_photo %}{{ contact.profile_photo.url }}{% else %}{% static 'message_app/images/Circle-icons-profile.svg.png' %}{% endif %}"
                     class="avatar-sm rounded-circle me-2 align-self-end">
                <div class="bg-white border-0 shadow-sm rounded-3 p-3" style="max-width: 70%; border-radius: 18px 18px 18px 5px !important;">
                  <p class="mb-1 small">{{ message.text }}</p>
                  <small class="text-secondary" style="font-size: 0.7rem;">{{ message.created_at|time:'H:i' }}</small>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>

        <!-- فرم ارسال پیام -->
        <div class="bg-white p-3 border-top">
          <form action="{% url 'send_message' contact.id %}" method="post" class="d-flex gap-2">
            {% csrf_token %}
            <input type="text" name="text" class="form-control bg-light border-0 " placeholder="پیام خود را بنویسید..." autofocus>
            <button type="submit" class="btn bg-primary text-light d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
              <i class="bi bi-send-fill"></i>
            </button>
          </form>
        </div>
      {% else %}
        <div class="h-100 d-flex flex-column align-items-center justify-content-center">
          <i class="bi bi-chat-dots fs-1 text-primary opacity-25"></i>
          <h5 class="fw-bold mt-3">گفتگویی انتخاب نشده</h5>
          <p class="text-secondary small">برای شروع گفتگو، یک مخاطب را انتخاب کنید</p>
          <a href="{% url 'contact_app:add_contact' %}" class="btn btn-primary-gradient rounded-pill px-5 py-2 mt-2">
            <i class="bi bi-person-plus me-2"></i>افزودن مخاطب جدید
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('messagesContainer');
    if (container) container.scrollTop = container.scrollHeight;
  });
</script>
{% endblock %}